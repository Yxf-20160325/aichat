<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>11 - AI聊天</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: Arial, sans-serif;
      background-color: #f5f5f5;
      color: #333;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }
    
    header {
      background-color: #4a6fa5;
      color: white;
      padding: 15px 0;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    nav {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0 20px;
    }
    
    .logo {
      font-size: 24px;
      font-weight: bold;
    }
    
    .nav-links {
      display: flex;
      gap: 20px;
      align-items: center;
    }
    
    .nav-links a {
      color: white;
      text-decoration: none;
      font-size: 16px;
    }
    
    .user-info {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .btn {
      display: inline-block;
      padding: 10px 20px;
      background-color: #4a6fa5;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      text-decoration: none;
      font-size: 14px;
    }
    
    .btn-sm {
      padding: 5px 10px;
      font-size: 12px;
    }
    
    .token-info {
      background-color: #f8f9fa;
      padding: 10px;
      border-radius: 4px;
      margin-bottom: 20px;
      font-size: 14px;
      max-width: 1200px;
      margin: 20px auto;
      padding: 10px 20px;
    }
    
    .main-container {
      flex: 1;
      max-width: 1200px;
      margin: 0 auto;
      width: 100%;
      padding: 0 20px;
    }
    
    .chat-container {
      background-color: white;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      overflow: hidden;
      height: calc(100vh - 200px);
      display: flex;
      flex-direction: column;
    }
    
    .chat-header {
      background-color: #4a6fa5;
      color: white;
      padding: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .chat-header h2 {
      margin: 0;
      font-size: 20px;
      font-weight: bold;
    }
    
    .chat-body {
      padding: 20px;
      flex: 1;
      overflow-y: auto;
      border-bottom: 1px solid #ddd;
    }
    
    .message {
      margin-bottom: 20px;
      display: flex;
      flex-direction: column;
    }
    
    .user-message {
      align-items: flex-end;
    }
    
    .ai-message {
      align-items: flex-start;
    }
    
    .message-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 5px;
      font-size: 14px;
    }
    
    .user-message .message-header {
      justify-content: flex-end;
    }
    
    .message-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      color: white;
    }
    
    .user-avatar {
      background-color: #28a745;
    }
    
    .ai-avatar {
      background-color: #4a6fa5;
    }
    
    .message-sender {
      font-weight: bold;
    }
    
    .message-time {
      color: #666;
      font-size: 12px;
    }
    
    .message-content {
      max-width: 80%;
      padding: 15px;
      border-radius: 18px;
      line-height: 1.4;
      white-space: pre-wrap;
      word-wrap: break-word;
    }
    
    .user-message .message-content {
      background-color: #4a6fa5;
      color: white;
      border-bottom-right-radius: 4px;
    }
    
    .ai-message .message-content {
      background-color: #f1f1f1;
      color: #333;
      border-bottom-left-radius: 4px;
    }
    
    .code-block {
      background-color: #2d2d2d;
      color: #f8f8f2;
      padding: 15px;
      border-radius: 8px;
      margin: 10px 0;
      font-family: 'Courier New', Courier, monospace;
      font-size: 14px;
      line-height: 1.5;
      overflow-x: auto;
      white-space: pre;
    }
    
    .markdown-content {
      line-height: 1.6;
    }
    
    .markdown-content h1 {
      font-size: 24px;
      font-weight: bold;
      margin: 10px 0;
    }
    
    .markdown-content h2 {
      font-size: 20px;
      font-weight: bold;
      margin: 10px 0;
    }
    
    .markdown-content h3 {
      font-size: 16px;
      font-weight: bold;
      margin: 10px 0;
    }
    
    .markdown-content p {
      margin: 10px 0;
    }
    
    .markdown-content ul,
    .markdown-content ol {
      margin: 10px 0;
      padding-left: 20px;
    }
    
    .markdown-content li {
      margin: 5px 0;
    }
    
    .markdown-content code {
      background-color: #f0f0f0;
      padding: 2px 4px;
      border-radius: 4px;
      font-family: 'Courier New', Courier, monospace;
      font-size: 14px;
    }
    
    .markdown-content blockquote {
      border-left: 4px solid #4a6fa5;
      padding-left: 10px;
      margin: 10px 0;
      color: #666;
    }
    
    .message-tokens {
      font-size: 12px;
      color: #666;
      margin-top: 5px;
    }
    
    .user-message .message-tokens {
      text-align: right;
    }
    
    .chat-footer {
      padding: 20px;
      display: flex;
      gap: 10px;
      border-top: 1px solid #ddd;
    }
    
    .chat-footer input {
      flex: 1;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 20px;
      font-size: 16px;
    }
    
    .chat-footer input:focus {
      outline: none;
      border-color: #4a6fa5;
      box-shadow: 0 0 0 2px rgba(74, 111, 165, 0.2);
    }
    
    .chat-footer button {
      padding: 0 24px;
      background-color: #4a6fa5;
      color: white;
      border: none;
      border-radius: 20px;
      cursor: pointer;
      font-size: 16px;
      font-weight: bold;
    }
    
    .chat-footer button:hover {
      background-color: #3a5a85;
    }
    
    .loading-message {
      display: flex;
      align-items: center;
      gap: 10px;
      color: #666;
      font-size: 14px;
    }
    
    .loading-spinner {
      width: 20px;
      height: 20px;
      border: 2px solid #f3f3f3;
      border-top: 2px solid #4a6fa5;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <header>
    <nav>
      <div class="logo">11</div>
      <div class="nav-links">
        <a href="/chat">聊天</a>
        <a href="/chat/recharge">充值</a>
        <a href="/profile">我的</a>
        <% if (user.isAdmin) { %>
        <a href="/admin">管理员</a>
        <% } %>
        <div class="user-info">
          <span>欢迎, <%= user.username %></span>
          <a href="/logout" class="btn btn-sm">登出</a>
        </div>
      </div>
    </nav>
  </header>
  
  <div class="main-container">
    <div class="token-info">
      <strong>剩余Token:</strong> <%= user.tokens %> | 
      <strong>模型:</strong> <%= setting.modelName %>
    </div>
    
    <div class="chat-container">
      <div class="chat-header">
        <h2>AI聊天</h2>
        <span>11</span>
      </div>
      <div class="chat-body" id="chat-body">
        <div class="message ai-message">
          <div class="message-header">
            <div class="message-avatar ai-avatar">AI</div>
            <div class="message-sender"><%= setting.modelName %></div>
            <div class="message-time"><%= new Date().toLocaleString() %></div>
          </div>
          <div class="message-content">
            system:你好！我是deepseek-v3</deepseek-v3>，很高兴为你服务。你可以免费使用1000个token
          </div>
        </div>
      </div>
      <div class="chat-footer">
        <input type="text" id="message-input" placeholder="输入你的消息...">
        <button class="btn" id="send-btn">发送</button>
      </div>
    </div>
  </div>
  
  <script>
    const chatBody = document.getElementById('chat-body');
    const messageInput = document.getElementById('message-input');
    const sendBtn = document.getElementById('send-btn');
    
    // 获取当前时间
    function getCurrentTime() {
      return new Date().toLocaleString();
    }
    
    // 添加消息到聊天界面
    function addMessage(content, sender, tokens = 0) {
      const messageDiv = document.createElement('div');
      messageDiv.className = 'message ' + sender + '-message';
      
      const avatarClass = sender === 'user' ? 'user-avatar' : 'ai-avatar';
      const avatarText = sender === 'user' ? 'U' : 'AI';
      const senderName = sender === 'user' ? '用户' : 'deepseek-v3';
      
      // 处理内容格式
      let processedContent = content;
      
      // 检测代码格式: 以 ``{代码格式} 开头
      if (content.startsWith('``{代码格式}')) {
        const codeContent = content.replace('``{代码格式}', '').trim();
        processedContent = `<div class="code-block">${codeContent}</div>`;
      }
      // 检测Markdown格式
      else if (content.includes('# ') || content.includes('**') || content.includes('* ') || content.includes('> ') || content.includes('```')) {
        processedContent = `<div class="markdown-content">${processMarkdown(content)}</div>`;
      }
      
      messageDiv.innerHTML = `
        <div class="message-header">
          <div class="message-avatar ${avatarClass}">${avatarText}</div>
          <div class="message-sender">${senderName}</div>
          <div class="message-time">${getCurrentTime()}</div>
        </div>
        <div class="message-content">${processedContent}</div>
        ${tokens > 0 ? `<div class="message-tokens">Tokens: ${tokens}</div>` : ''}
      `;
      
      chatBody.appendChild(messageDiv);
      chatBody.scrollTop = chatBody.scrollHeight;
    }
    
    // 处理Markdown格式
    function processMarkdown(text) {
      // 首先提取所有代码块，避免它们被其他规则处理
      const codeBlocks = [];
      let textWithPlaceholders = text.replace(/```(.*?)```/gs, (match, code) => {
        const placeholder = `__CODE_BLOCK_${codeBlocks.length}__`;
        codeBlocks.push(code);
        return placeholder;
      });
      
      // 处理其他Markdown元素
      let processedText = textWithPlaceholders
        // 标题
        .replace(/^# (.*$)/gm, '<h1>$1</h1>')
        .replace(/^## (.*$)/gm, '<h2>$1</h2>')
        .replace(/^### (.*$)/gm, '<h3>$1</h3>')
        // 粗体
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        // 斜体
        .replace(/\*(.*?)\*/g, '<em>$1</em>')
        // 列表
        .replace(/^\* (.*$)/gm, '<ul><li>$1</li></ul>')
        .replace(/(<\/ul>)(<ul>)/g, '')
        // 引用
        .replace(/^> (.*$)/gm, '<blockquote>$1</blockquote>')
        // 行内代码
        .replace(/`(.*?)`/g, '<code>$1</code>')
        // 段落
        .replace(/^(?!<h[1-6]>)(?!<ul>)(?!<blockquote>)(?!<div class="code-block">)(.*$)/gm, '<p>$1</p>');
      
      // 恢复代码块
      codeBlocks.forEach((code, index) => {
        processedText = processedText.replace(`__CODE_BLOCK_${index}__`, `<div class="code-block">${code}</div>`);
      });
      
      return processedText;
    }
    
    // 添加加载状态
    function addLoadingMessage() {
      const loadingDiv = document.createElement('div');
      loadingDiv.id = 'loading-message';
      loadingDiv.className = 'message ai-message';
      loadingDiv.innerHTML = `
        <div class="message-header">
          <div class="message-avatar ai-avatar">AI</div>
          <div class="message-sender"></div>
          <div class="message-time">${getCurrentTime()}</div>
        </div>
        <div class="message-content loading-message">
          <div class="loading-spinner"></div>
          <span>AI正在思考...</span>
        </div>
      `;
      
      chatBody.appendChild(loadingDiv);
      chatBody.scrollTop = chatBody.scrollHeight;
      return loadingDiv;
    }
    
    // 移除加载状态
    function removeLoadingMessage(loadingDiv) {
      if (loadingDiv) {
        loadingDiv.remove();
      }
    }
    
    // 发送消息
    function sendMessage() {
      const message = messageInput.value.trim();
      if (!message) return;
      
      // 添加用户消息
      addMessage(message, 'user');
      messageInput.value = '';
      
      // 检查是否为dev命令
      if (message === 'dev') {
        // 显示原始信息
        showRawInfo();
        return;
      }
      
      // 显示加载状态
      const loadingDiv = addLoadingMessage();
      
      // 发送请求
      fetch('/chat/send', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ message: message })
      })
      .then(response => response.json())
      .then(data => {
        // 移除加载状态
        removeLoadingMessage(loadingDiv);
        
        // 添加AI回复
        if (data.error) {
          addMessage(data.error, 'ai');
        } else {
          // 计算使用的token数
          // 从当前显示的token数中获取
          const currentTokenElement = document.querySelector('.token-info');
          const currentTokensText = currentTokenElement.textContent;
          const currentTokens = parseInt(currentTokensText.match(/剩余Token:\s*(\d+)/)[1]);
          const usedTokens = currentTokens - data.remainingTokens;
          addMessage(data.response, 'ai', usedTokens > 0 ? usedTokens : 0);
          
          // 更新token信息
          const tokenInfo = document.querySelector('.token-info');
          tokenInfo.innerHTML = `<strong>剩余Token:</strong> ${data.remainingTokens} | <strong>模型:</strong> <%= setting.modelName %>`;
        }
      })
      .catch(error => {
        console.error('发送消息失败:', error);
        removeLoadingMessage(loadingDiv);
        addMessage('发送失败，请重试', 'ai');
      });
    }
    
    // 显示原始信息
    function showRawInfo() {
      // 获取用户信息和设置信息
      const userInfo = {
        username: '<%= user.username %>',
        tokens: '<%= user.tokens %>',
        isAdmin: '<%= user.isAdmin %>',
        isBanned: '<%= user.isBanned %>'
      };
      
      const settingInfo = {
        modelName: '<%= setting.modelName %>',
        apiUrl: '<%= setting.apiUrl %>'
      };
      
      // 构建原始信息内容
      let rawContent = '=== 原始信息 ===\n';
      rawContent += '\n=== 用户信息 ===\n';
      rawContent += JSON.stringify(userInfo, null, 2);
      rawContent += '\n\n=== 设置信息 ===\n';
      rawContent += JSON.stringify(settingInfo, null, 2);
      rawContent += '\n\n=== 注意 ===\n';
      rawContent += '此信息为原始数据，未经过Markdown或代码格式解析';
      
      // 添加到聊天界面，不应用格式解析
      const messageDiv = document.createElement('div');
      messageDiv.className = 'message ai-message';
      
      const avatarClass = 'ai-avatar';
      const avatarText = 'AI';
      const senderName = 'deepseek-v3';
      
      messageDiv.innerHTML = `
        <div class="message-header">
          <div class="message-avatar ${avatarClass}">${avatarText}</div>
          <div class="message-sender">${senderName}</div>
          <div class="message-time">${getCurrentTime()}</div>
        </div>
        <div class="message-content">${rawContent}</div>
      `;
      
      const chatBody = document.getElementById('chat-body');
      chatBody.appendChild(messageDiv);
      chatBody.scrollTop = chatBody.scrollHeight;
    }
    
    // 绑定事件
    sendBtn.addEventListener('click', sendMessage);
    messageInput.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        sendMessage();
      }
    });
  </script>
</body>
</html>
